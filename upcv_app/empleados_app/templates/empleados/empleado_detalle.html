{% extends 'empleados/base.html' %}
{% load static %}
{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fontfaceobserver/2.1.0/fontfaceobserver.standalone.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Mordato:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
{% include 'empleados/partials_gafete_estilos.html' %}

<div class="page-body">
  <div class="container-fluid">
    <div class="edit-profile">
      <div class="row">
        <div class="gafetes-container">
          <div class="col-xl-12 gafete">
            <div class="card" style="width: 880px; height: 565px;">
              <div class="card-body gafete-card" id="gafete" style="width: 880px; height: 565px; background: url('{% if establecimiento and establecimiento.background_gafete and layout.background %}{{ establecimiento.background_gafete.url }}{% else %}{% static 'assets/svg/empleado.svg' %}{% endif %}') no-repeat center center;">
                <div class="gafete-header">
                  <text x="150%" y="55" class="t3" font-size="29" font-weight="bold" fill="#182b55">{{ configuracion.nombre_institucion }}</text>
                  <text x="70%" y="50" class="t4" font-size="29" font-weight="bold" fill="#182b55">{{ configuracion.nombre_institucion2 }}</text>
                </div>
                <div><text x="70" y="20" class="{{ layout.layers.nombres.class|default:'t5' }}" font-size="30" fill="#182b55">{{ empleado.nombres|default:"Nombre no disponible" }}</text></div>
                <div><text x="70" y="20" class="{{ layout.layers.apellidos.class|default:'t6' }}" font-size="39" font-weight="bold" fill="#182b55">{{ empleado.apellidos|default:"Apellidos no disponibles" }}</text></div>
                <div><text x="70" y="20" class="{{ layout.layers.grado.class|default:'t7' }}" font-size="39" font-weight="bold" fill="#182b55">{{ empleado.grado|default:" no ingresado" }}</text></div>
                <div><text x="70" y="20" class="{{ layout.layers.grado_descripcion.class|default:'t8' }}" font-size="39" font-weight="bold" fill="#182b55">{{ empleado.grado.descripcion|default:"" }}</text></div>
                <div><text x="570" y="20" class="{{ layout.layers.sitio_web.class|default:'t10' }}" font-size="39" font-weight="bold" fill="#182b55">{{ configuracion.sitio_web|slice:"8:" }}</text></div>
                <div><text x="570" y="20" class="{{ layout.layers.telefono.class|default:'t11' }}" font-size="39" font-weight="bold" fill="#182b55">{{ empleado.tel }}</text></div>

                {% if empleado.imagen %}
                  <img src="{{ empleado.imagen.url }}" alt="Imagen del alumno" width="150" height="auto" class="gafete-img">
                {% else %}
                  <p>No hay imagen cargada</p>
                {% endif %}

                <div style="display: flex; justify-content: space-between; padding: 50px; flex-wrap: wrap;">
                  <svg width="880" height="565"></svg>
                  <div class="logotipos">
                    {% if configuracion.logotipo %}
                    <div class="logotipo"><img src="{{ configuracion.logotipo.url }}" alt="Logotipo" width="170" height="auto"></div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% if user.is_authenticated %}
<div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
  <button id="download-gafete-button" onclick="downloadGafete()" style="padding: 12px 25px; background-color: #180269; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer;">Descargar Gafete</button>
</div>
{% endif %}

<script>
function downloadGafete() {
  var element = document.getElementById('gafete');
  html2canvas(element, {useCORS: true, backgroundColor: null, scale: 3, width: 880, height: 565, allowTaint: true, logging: true})
  .then(function(canvas) {
    var link = document.createElement('a');
    var nombreEmpleado = '{{ empleado.nombres }}' || 'alumno';
    var apellidosEmpleado = '{{ empleado.apellidos }}' || 'desconocido';
    link.href = canvas.toDataURL('image/jpeg', 1.0);
    link.download = nombreEmpleado + '_' + apellidosEmpleado + '_gafete.jpg';
    link.click();
  }).catch(function(error) {
    console.error('Error al generar la imagen:', error);
  });
}
</script>
{% endblock %}
