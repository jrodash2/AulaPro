{% extends 'empleados/base.html' %}
{% load static %}
{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Mordato:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
{% include 'empleados/partials_gafete_estilos.html' %}
<style>
  .gafete-modal-body { background: var(--bs-light); padding: .5rem; }
  .gafete-preview-viewport {
    width: 100%;
    max-height: 80vh;
    min-height: 300px;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 4px;
    border: 1px solid rgba(82, 82, 108, 0.15);
    border-radius: 12px;
    background: #fff;
  }
  .gafete-preview-scale {
    display: inline-block;
    transform-origin: top left;
  }
  .gafete-modal-canvas-wrap {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-width: fit-content;
  }
  .gafete-export-hidden {
    position: fixed;
    left: -100000px;
    top: 0;
    opacity: 0;
    pointer-events: none;
    z-index: -1;
  }

  .gafete-export-hidden .gafete-canvas-real {
    width: 1011px !important;
    height: 639px !important;
    transform: none !important;
  }
  .gafete-export-canvas {
    width: 1011px;
    height: 639px;
    position: relative;
    overflow: hidden;
    transform: none !important;
  }
  #gafete-export-root .gafete-photo {
    object-fit: cover !important;
  }
</style>
<div class="page-body"><div class="container-fluid"><div class="page-title"><div class="row"><div class="col-6"><h4>{{ grado.nombre }}</h4></div><div class="col-6"><ol class="breadcrumb"><li class="breadcrumb-item">AulaPro</li><li class="breadcrumb-item"><a href="{% url 'empleados:establecimientos_list' %}">Establecimientos</a></li><li class="breadcrumb-item"><a href="{% url 'empleados:establecimiento_detail' establecimiento.id %}">{{ establecimiento.nombre }}</a></li><li class="breadcrumb-item"><a href="{% url 'empleados:carrera_detail' establecimiento.id carrera.id %}">{{ carrera.nombre }}</a></li><li class="breadcrumb-item active">{{ grado.nombre }}</li></ol></div></div></div></div>
<div class="container-fluid">
  <div class="card">
    <div class="card-header card-no-border pb-0 d-flex justify-content-between align-items-center">
      <h5>Alumnos matriculados</h5>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#matricularModal" type="button"><i class="fa fa-user-plus"></i> Matricular</button>
    </div>
    <div class="card-body">
      <form method="get" class="row g-3 mb-3">
        <div class="col-md-4"><label class="form-label">Ciclo</label>{{ filtro_form.ciclo_escolar }}</div>
        <div class="col-md-3"><label class="form-label">Estado</label>{{ filtro_form.estado }}</div>
        <div class="col-md-2 d-flex align-items-end"><button class="btn btn-outline-secondary w-100" type="submit">Filtrar</button></div>
      </form>

      {% if ciclo_activo %}
      <div class="alert alert-light-success">Ciclo activo del establecimiento: <strong>{{ ciclo_activo.nombre }}</strong>.</div>
      {% else %}
      <div class="alert alert-light-danger">No hay ciclo escolar activo en este establecimiento.</div>
      {% endif %}

      <div class="table-responsive">
        <table class="table table-striped">
          <thead><tr><th>Código</th><th>Alumno</th><th>CUI</th><th>Ciclo</th><th>Estado</th><th>Acciones</th><th></th></tr></thead>
          <tbody>
            {% for m in matriculas %}
            {% with m.id|stringformat:"s" as mid %}
            <tr>
              <td>{{ m.alumno.codigo_personal|default:'-' }}</td>
              <td>{{ m.alumno.apellidos }}, {{ m.alumno.nombres }}</td>
              <td>{{ m.alumno.cui|default:'-' }}</td>
              <td>{{ m.ciclo_escolar.nombre|default:'-' }}</td>
              <td>{% if m.estado == 'activo' %}<span class="badge badge-light-success">Activo</span>{% else %}<span class="badge badge-light-danger">Inactivo</span>{% endif %}</td>
              <td>
                <div class="btn-group" role="group" aria-label="Acciones gafete">
                  <button class="btn btn-primary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#gafeteModal{{ m.id }}"><i class="fa fa-id-card me-1"></i>Ver gafete</button>
                  <button class="btn btn-outline-primary btn-sm gafete-export-btn" type="button"
                    data-export-id="{{ mid }}"
                    data-filename="GAFETE_{{ m.alumno.apellidos|slugify }}_{{ m.alumno.nombres|slugify }}_{{ m.alumno.codigo_personal|default:'NA'|slugify }}.jpg">
                    <i class="fa fa-download me-1"></i>Descargar JPG
                  </button>
                </div>
              </td>
              <td>
                <form method="post" action="{% url 'empleados:desmatricular_alumno' m.id %}">{% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}">
                  <button class="btn btn-outline-danger btn-sm" type="submit">Desmatricular</button>
                </form>
              </td>
            </tr>
            {% endwith %}
            {% empty %}
            <tr><td colspan="7">Sin matrículas para los filtros seleccionados.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% for m in matriculas %}
{% with m.id|stringformat:"s" as mid %}
{% with preview_dom_id='gafete-canvas-'|add:mid %}
<div class="modal fade" id="gafeteModal{{ m.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-bottom-0 pb-0">
        <div>
          <h5 class="modal-title mb-1">Gafete</h5>
          <p class="text-muted mb-0">{{ m.alumno.apellidos }}, {{ m.alumno.nombres }} · Código {{ m.alumno.codigo_personal|default:'-' }}</p>
          <small class="text-muted">{{ m.grado.nombre|default:'Sin grado' }} · {{ establecimiento.nombre|default:'Sin establecimiento' }}</small>
        </div>
        <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body gafete-modal-body">
        <div class="gafete-preview-viewport mx-auto text-center" id="vp-{{ mid }}">
          <div class="gafete-modal-canvas-wrap">
            <div class="gafete-preview-scale" id="wrap-{{ mid }}">
              {% include 'aulapro/partials/_gafete_canvas.html' with alumno=m.alumno grado=m.grado establecimiento=establecimiento layout_json=layout canvas_width=canvas_width canvas_height=canvas_height preview_id=preview_dom_id %}
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endwith %}
{% endwith %}
{% endfor %}

<div id="gafete-export-root" class="gafete-export-hidden" style="position:fixed; left:-99999px; top:0; opacity:1;" aria-hidden="true">
  {% for m in matriculas %}
  {% with m.id|stringformat:"s" as mid %}
    <div id="gafete-export-{{ mid }}" class="gafete-export-canvas" style="width:1011px;height:639px;position:relative;overflow:hidden;">
      {% include 'aulapro/partials/_gafete_canvas.html' with alumno=m.alumno grado=m.grado establecimiento=establecimiento layout_json=layout canvas_width=canvas_width canvas_height=canvas_height preview_id='gafete-export-canvas-'|add:mid export_mode=True is_editor=False %}
    </div>
  {% endwith %}
  {% endfor %}
</div>

<div id="export-sandbox" style="position:fixed;left:-99999px;top:0;width:0;height:0;overflow:hidden;"></div>

<div class="modal fade" id="matricularModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Matricular alumno</h5>
        <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="matricula-modal-alert"></div>
        <div class="mb-3">
          <label class="form-label">Buscar por código personal</label>
          <div class="input-group">
            <input id="matricula-codigo" type="text" class="form-control" placeholder="Ej. A-1001">
            <button id="matricula-buscar-btn" class="btn btn-primary" type="button">Buscar</button>
          </div>
        </div>

        {% if ciclo_activo %}
          <div class="alert alert-light-success">Ciclo activo: <strong id="ciclo-activo-label">{{ ciclo_activo.nombre }}</strong></div>
        {% else %}
          <div class="alert alert-danger">No hay ciclo escolar activo en este establecimiento. Activa uno para matricular.</div>
        {% endif %}

        <div id="matricula-alumno-result" class="d-none"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
window.matriculaModalConfig = {
  buscarUrl: "{% url 'empleados:buscar_alumno' grado.id %}",
  matricularUrl: "{% url 'empleados:matricular_alumno' grado.id %}",
  csrfToken: "{{ csrf_token }}",
  tieneCicloActivo: {{ ciclo_activo|yesno:'true,false' }}
};
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="{% static 'aulapro/js/matricula_modal.js' %}"></script>
<script src="{% static 'aulapro/js/gafete_preview_scale_v2.js' %}"></script>
<script src="{% static 'aulapro/js/gafete_export_fix.js' %}"></script>
{% endblock %}
