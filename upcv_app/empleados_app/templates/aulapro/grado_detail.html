{% extends 'empleados/base.html' %}
{% load static %}
{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Mordato:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
{% include 'empleados/partials_gafete_estilos.html' %}
<div class="page-body"><div class="container-fluid"><div class="page-title"><div class="row"><div class="col-6"><h4>{{ grado.nombre }}</h4></div><div class="col-6"><ol class="breadcrumb"><li class="breadcrumb-item">AulaPro</li><li class="breadcrumb-item"><a href="{% url 'empleados:establecimientos_list' %}">Establecimientos</a></li><li class="breadcrumb-item"><a href="{% url 'empleados:establecimiento_detail' establecimiento.id %}">{{ establecimiento.nombre }}</a></li><li class="breadcrumb-item"><a href="{% url 'empleados:carrera_detail' establecimiento.id carrera.id %}">{{ carrera.nombre }}</a></li><li class="breadcrumb-item active">{{ grado.nombre }}</li></ol></div></div></div></div>
<div class="container-fluid">
  <div class="card">
    <div class="card-header card-no-border pb-0 d-flex justify-content-between align-items-center">
      <h5>Alumnos matriculados</h5>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#matricularModal" type="button"><i class="fa fa-user-plus"></i> Matricular</button>
    </div>
    <div class="card-body">
      <form method="get" class="row g-3 mb-3">
        <div class="col-md-4"><label class="form-label">Ciclo</label>{{ filtro_form.ciclo_escolar }}</div>
        <div class="col-md-3"><label class="form-label">Estado</label>{{ filtro_form.estado }}</div>
        <div class="col-md-2 d-flex align-items-end"><button class="btn btn-outline-secondary w-100" type="submit">Filtrar</button></div>
      </form>

      {% if ciclo_activo %}
      <div class="alert alert-light-success">Ciclo activo del establecimiento: <strong>{{ ciclo_activo.nombre }}</strong>.</div>
      {% else %}
      <div class="alert alert-light-danger">No hay ciclo escolar activo en este establecimiento.</div>
      {% endif %}

      <div class="table-responsive">
        <table class="table table-striped">
          <thead><tr><th>Código</th><th>Alumno</th><th>CUI</th><th>Ciclo</th><th>Estado</th><th>Gafete</th><th></th></tr></thead>
          <tbody>
            {% for m in matriculas %}
            <tr>
              <td>{{ m.alumno.codigo_personal|default:'-' }}</td>
              <td>{{ m.alumno.apellidos }}, {{ m.alumno.nombres }}</td>
              <td>{{ m.alumno.cui|default:'-' }}</td>
              <td>{{ m.ciclo_escolar.nombre|default:'-' }}</td>
              <td>{% if m.estado == 'activo' %}<span class="badge badge-light-success">Activo</span>{% else %}<span class="badge badge-light-danger">Inactivo</span>{% endif %}</td>
              <td><button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#gafeteModal{{ m.id }}">Ver gafete</button></td>
              <td>
                <form method="post" action="{% url 'empleados:desmatricular_alumno' m.id %}">{% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}">
                  <button class="btn btn-outline-danger btn-sm" type="submit">Desmatricular</button>
                </form>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="7">Sin matrículas para los filtros seleccionados.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% for m in matriculas %}
<div class="modal fade" id="gafeteModal{{ m.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Gafete: {{ m.alumno.apellidos }}, {{ m.alumno.nombres }}</h5>
        <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body d-flex justify-content-center">
        {% include 'aulapro/partials/_gafete_preview.html' with alumno=m.alumno grado=m.grado %}
      </div>
    </div>
  </div>
</div>
{% endfor %}

<div class="modal fade" id="matricularModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Matricular alumno</h5>
        <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="matricula-modal-alert"></div>
        <div class="mb-3">
          <label class="form-label">Buscar por código personal</label>
          <div class="input-group">
            <input id="matricula-codigo" type="text" class="form-control" placeholder="Ej. A-1001">
            <button id="matricula-buscar-btn" class="btn btn-primary" type="button">Buscar</button>
          </div>
        </div>

        {% if ciclo_activo %}
          <div class="alert alert-light-success">Ciclo activo: <strong id="ciclo-activo-label">{{ ciclo_activo.nombre }}</strong></div>
        {% else %}
          <div class="alert alert-danger">No hay ciclo escolar activo en este establecimiento. Activa uno para matricular.</div>
        {% endif %}

        <div id="matricula-alumno-result" class="d-none"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
window.matriculaModalConfig = {
  buscarUrl: "{% url 'empleados:buscar_alumno' grado.id %}",
  matricularUrl: "{% url 'empleados:matricular_alumno' grado.id %}",
  csrfToken: "{{ csrf_token }}",
  tieneCicloActivo: {{ ciclo_activo|yesno:'true,false' }}
};
</script>
<script src="{% static 'aulapro/js/matricula_modal.js' %}"></script>
{% endblock %}
